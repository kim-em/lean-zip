#!/usr/bin/env bash
# coordination â€” multi-agent coordination for lean-zip
#
# All subcommands use `gh` CLI. Reads session UUID from $LEAN_ZIP_SESSION_ID
# (exported by ./go). Reads branch from git.
#
# Usage:
#   coordination orient         â€” list open plans, PRs, issues needing attention
#   coordination close-stale    â€” close agent-plan issues open >24 hours
#   coordination plan "title"   â€” create GitHub issue with agent-plan label (body from stdin)
#   coordination create-pr N    â€” push branch, create PR closing issue #N, enable auto-merge
#   coordination claim-fix N    â€” comment on failing PR #N claiming fix (30min cooldown)
#   coordination close-pr N "reason" â€” comment reason and close PR #N

set -euo pipefail

REPO="kim-em/lean-zip"
SESSION_ID="${LEAN_ZIP_SESSION_ID:-unknown}"
BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo detached)"

die() { echo "error: $*" >&2; exit 1; }

# Verify gh CLI is authenticated
gh auth status --hostname github.com >/dev/null 2>&1 || \
    die "gh CLI not authenticated â€” run 'gh auth login' first"

# --- orient ---
cmd_orient() {
    echo "=== Open agent-plan issues ==="
    gh issue list --repo "$REPO" --label agent-plan --state open --limit 20 \
        --json number,title,createdAt \
        --template '{{range .}}#{{.number}} {{.title}} ({{timeago .createdAt}}){{"\n"}}{{end}}'

    echo ""
    echo "=== Open pull requests ==="
    gh pr list --repo "$REPO" --state open --limit 20 \
        --json number,title,headRefName,statusCheckRollup,labels \
        --template '{{range .}}#{{.number}} [{{.headRefName}}] {{.title}}{{range .labels}} ({{.name}}){{end}}{{range .statusCheckRollup}}{{if eq .status "FAILURE"}} âœ—CI{{end}}{{end}}{{"\n"}}{{end}}'

    echo ""
    echo "=== PRs needing attention (failing CI or merge-conflict) ==="
    gh pr list --repo "$REPO" --state open --limit 20 \
        --json number,title,labels,statusCheckRollup \
        --jq '[.[] | select(
            (.labels | any(.name == "merge-conflict")) or
            (.statusCheckRollup | any(.status == "FAILURE"))
        )] | .[] | "#\(.number) \(.title)"'
}

# --- close-stale ---
cmd_close_stale() {
    local cutoff
    cutoff="$(date -u -v-24H '+%Y-%m-%dT%H:%M:%SZ' 2>/dev/null || \
              date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%SZ')"

    gh issue list --repo "$REPO" --label agent-plan --state open --limit 50 \
        --json number,title,createdAt \
        --jq ".[] | select(.createdAt < \"$cutoff\") | .number" | \
    while read -r num; do
        echo "Closing stale issue #$num"
        gh issue close "$num" --repo "$REPO" \
            --comment "Presumed abandoned (open >24 hours). Session: $SESSION_ID"
    done
}

# --- plan ---
cmd_plan() {
    local title="${1:?usage: coordination plan \"title\"}"

    # Check for similar open issues
    local existing
    existing="$(gh issue list --repo "$REPO" --label agent-plan --state open \
        --json number,title --jq '.[].title')"
    if echo "$existing" | grep -qi "$(echo "$title" | cut -c1-30)"; then
        echo "warning: similar open issue exists:"
        echo "$existing" | grep -i "$(echo "$title" | cut -c1-30)"
        echo "Proceeding anyway..."
    fi

    local body
    body="$(cat)"

    local issue_url
    issue_url="$(gh issue create --repo "$REPO" \
        --title "$title" \
        --label agent-plan \
        --body "$body")"

    # Extract issue number from the URL returned by gh issue create
    local issue_num
    issue_num="${issue_url##*/}"

    if [[ -n "$issue_num" ]]; then
        gh issue comment "$issue_num" --repo "$REPO" \
            --body "Session: \`$SESSION_ID\` Branch: \`$BRANCH\`"
    fi
}

# --- create-pr ---
cmd_create_pr() {
    local issue_num="${1:?usage: coordination create-pr N}"

    # Guard: refuse to create PR from master or detached HEAD
    if [[ "$BRANCH" == "master" || "$BRANCH" == "main" || "$BRANCH" == "detached" ]]; then
        die "cannot create PR from branch '$BRANCH' â€” use an agent/* branch"
    fi

    # Push branch
    git push -u origin "$BRANCH"

    # Check if PR already exists for this branch
    local existing_pr
    existing_pr="$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number // empty')"
    if [[ -n "$existing_pr" ]]; then
        echo "PR #$existing_pr already exists for branch $BRANCH. Enabling auto-merge."
        gh pr merge "$existing_pr" --repo "$REPO" --auto --squash || \
            echo "warning: auto-merge not available (branch protection may not be set up)"
        return 0
    fi

    # Create PR
    gh pr create --repo "$REPO" \
        --head "$BRANCH" \
        --title "$(gh issue view "$issue_num" --repo "$REPO" --json title --jq .title)" \
        --body "$(cat <<EOF
Closes #$issue_num

Session: \`$SESSION_ID\`

$(git log origin/master..HEAD --oneline)

ðŸ¤– Prepared with Claude Code
EOF
)"

    # Enable auto-merge
    local pr_num
    pr_num="$(gh pr list --repo "$REPO" --head "$BRANCH" --json number --jq '.[0].number')"
    if [[ -n "$pr_num" ]]; then
        gh pr merge "$pr_num" --repo "$REPO" --auto --squash || \
            echo "warning: auto-merge not available (branch protection may not be set up)"
    fi
}

# --- claim-fix ---
# NOTE: claim-fix is best-effort advisory, not strict mutual exclusion.
# Two agents may both claim the same PR in a narrow race window.
# Branch protection serializes the actual merges, so worst case is
# duplicate work, not corruption.
cmd_claim_fix() {
    local pr_num="${1:?usage: coordination claim-fix N}"

    # Check for recent claims (last 30 minutes)
    local recent_claim
    recent_claim="$(gh api "repos/$REPO/issues/$pr_num/comments" \
        --jq '[.[] | select(.body | test("Session .* attempting fix")) |
               select(.created_at > (now - 1800 | strftime("%Y-%m-%dT%H:%M:%SZ")))] |
               length')"

    if [[ "$recent_claim" -gt 0 ]]; then
        echo "Another session claimed this PR in the last 30 minutes. Skipping."
        return 1
    fi

    gh issue comment "$pr_num" --repo "$REPO" \
        --body "Session \`$SESSION_ID\` attempting fix on branch \`$BRANCH\`"
}

# --- close-pr ---
cmd_close_pr() {
    local pr_num="${1:?usage: coordination close-pr N \"reason\"}"
    local reason="${2:?usage: coordination close-pr N \"reason\"}"

    gh pr close "$pr_num" --repo "$REPO" \
        --comment "$reason (Session: \`$SESSION_ID\`)"
}

# --- dispatch ---
case "${1:-}" in
    orient)      cmd_orient ;;
    close-stale) cmd_close_stale ;;
    plan)        shift; cmd_plan "$@" ;;
    create-pr)   shift; cmd_create_pr "$@" ;;
    claim-fix)   shift; cmd_claim_fix "$@" ;;
    close-pr)    shift; cmd_close_pr "$@" ;;
    *)           die "unknown command: ${1:-}
Usage: coordination {orient|close-stale|plan|create-pr|claim-fix|close-pr}" ;;
esac
