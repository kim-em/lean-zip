# Progress: Review of LZ77NativeCorrect and BitstreamCorrect

**Date**: 2026-02-24 11:41 UTC
**Session type**: Review (proof quality and code organization)
**Issue**: #175

## Accomplished

### Review findings

**LZ77NativeCorrect.lean (718 → 701 lines)**:
- Greedy/lazy `go_matches`, `countMatch_matches`, `trailing_valid`,
  `trailing_encodable`, `trailing_length` are duplicated (~65 lines).
  They operate on separate `where` definitions (`lz77Greedy.go` vs
  `lz77Lazy.go`) with identical bodies. Deduplication would require
  parametric proofs taking unfolding equations as hypotheses — adds
  complexity for modest savings. Left as-is.
- `ByteArray.getElem_toList`, `ByteArray.getElem!_toList`, and
  `toList_length` were private helpers. Extracted to ZipForStd.
- `lazyRef_at_pos` had an unused `_hw : windowSize > 0` parameter.
- No dead code or unused theorems found.
- All `protected` theorems are correctly scoped.
- Section headers are accurate.

**BitstreamCorrect.lean (624 → 621 lines)**:
- All 14 private helpers are truly internal — not referenced elsewhere.
- All 8 protected theorems are correctly used by BitstreamComplete.lean.
- `flatMap_drop_mul`, `flatMap_uniform_drop` are general List lemmas
  but only used internally — didn't extract to ZipForStd since no
  current external need.
- Three trailing `done` statements were no-ops after `simp`/`rw`.
- Proofs are well-structured and minimal. `readBits_go_spec` (48 lines)
  is the longest proof and already clean.
- No bare `simp` calls that should be `simp only` — the bare ones
  are justified (closing contradictions, unfolding complex do-notation).

### Concrete improvements applied

1. **Extracted ByteArray lemmas to ZipForStd/ByteArray.lean**: Created
   new module with `ByteArray.getElem_toList`, `ByteArray.getElem!_toList`,
   and `ByteArray.data_toList_length` — general-purpose API lemmas
   suitable for upstreaming to Lean's standard library.

2. **Removed unused parameter**: Dropped `_hw : windowSize > 0` from
   `lazyRef_at_pos` helper and updated 4 call sites.

3. **Removed redundant `done` statements**: Three trailing `done`
   tactics in BitstreamCorrect.lean were no-ops.

## Sorry count

Start: 3 (all in DeflateFixedCorrect.lean)
End: 3 (unchanged)

## What remains

- Greedy/lazy proof deduplication (parametric proofs) — modest benefit,
  significant complexity; not worth pursuing now
- `flatMap_drop_mul` and `flatMap_uniform_drop` could be extracted to
  ZipForStd/List.lean if needed elsewhere in the future
