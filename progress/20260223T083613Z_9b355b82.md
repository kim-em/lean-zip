# Progress: BitWriter correctness proofs

- **Date**: 2026-02-23 08:36 UTC
- **Session**: worker (issue #43)
- **Branch**: agent/9b355b82

## What was accomplished

Created `Zip/Spec/BitWriterCorrect.lean` with complete formal correspondence
proofs between the native `BitWriter` and spec-level bitstream functions.

### Theorems proved (no sorry)

- `empty_wf`, `empty_toBits` — trivial base cases
- `flush_toBits` — flushing produces `bw.toBits ++ padding`
- `addBit_toBits`, `addBit_wf` — core single-bit lemmas bridging UInt8
  bit manipulation to Nat-level testBit
- `writeHuffCode_toBits`, `writeHuffCode_wf` — MSB-first Huffman code
  writing corresponds to `Huffman.Spec.natToBits`
- `writeBits_toBits`, `writeBits_wf` — LSB-first bit writing corresponds
  to `Deflate.Spec.writeBitsLSB`

### Key helper lemmas

- `flush_iff_nat` — bridges UInt8 comparison `bc + 1 >= 8` to Nat comparison
- `uint16_extract_bit`, `uint32_extract_bit` — extract single bit from
  UInt16/UInt32 values with testBit correspondence
- `range_map_extend` — extending a testBit range by one element
- `byteToBits_split` — splitting byteToBits at a bit boundary
- `uint8_or_shiftLeft_toNat` — UInt8 OR-shift distributes to Nat

### Key decisions

- Used `toBits` abstraction: `data.flatMap byteToBits ++ (range k).map (testBit bitBuf)`
- Well-formedness predicate: `bitCount < 8 /\ bitBuf < 2^bitCount`
- `writeBits_go_spec` needed plain induction on `n - i` (not functional
  induction) because `writeBits.go` uses UInt8 comparison while `addBit`
  lemmas use Nat comparison — functional induction gives UInt8 hypotheses
  that can't directly rewrite Nat conditions
- `flush_iff_nat` bridges UInt8 and Nat comparison using
  `UInt8.le_iff_toNat_le` + `UInt8.toNat_add`

### Proof patterns discovered

- `Nat.and_one_is_mod : x &&& 1 = x % 2` (for `x &&& 1`)
- `Nat.one_and_eq_mod_two : 1 &&& n = n % 2` (for `1 &&& x` as in `Nat.testBit`)
- `UInt8.le_iff_toNat_le : a <= b <-> a.toNat <= b.toNat` — for converting
  between UInt8 and Nat comparisons

## Sorry count

- Before: 2 (both in `Zip/Spec/Deflate.lean`)
- After: 2 (unchanged — `BitWriterCorrect.lean` has 0 sorries)
