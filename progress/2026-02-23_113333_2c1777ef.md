# Progress: LZ77 Module Review

**Date**: 2026-02-23 11:33 UTC
**Session type**: Review (proof quality + Lean idioms)
**Issue**: #90

## What was done

Reviewed all three LZ77 module files (~1315 lines total):
- `Zip/Spec/LZ77.lean` (576 → 570 lines)
- `Zip/Spec/LZ77Lazy.lean` (367 → 353 lines)
- `Zip/Spec/LZ77NativeCorrect.lean` (372 → 364 lines)

### Proof improvements (4 concrete changes)

1. **`resolveLZ77_reference_valid`** (LZ77.lean): Removed two unnecessary
   intermediate `have`s that just renamed existing hypotheses. Replaced with
   direct `simp` arguments.

2. **`matchLZ77Lazy.go_correct`** (LZ77.lean): Factored out three identical
   greedy-reference-M1 proof blocks into a single `have greedy_m1` local
   lemma. Each of the three branches (`len2 ≤ len1`, `findLongestMatch none`,
   `¬(pos + 1 < data.length)`) now just calls `greedy_m1`.

3. **`matchLZ77Lazy.go_encodable`** (LZ77Lazy.lean): Factored out three
   identical reference-M1 encodability proofs into a single `have henc_m1`
   local lemma. Each branch that previously had 8 lines of `findLongestMatch_*`
   calls now uses `exact henc_m1`.

4. **`mainLoop_valid` and `mainLoop_encodable`** (LZ77NativeCorrect.lean):
   Replaced verbose `by_cases` + `exfalso` + `simp [decide_eq_false ...]`
   patterns for extracting boolean conditions with cleaner
   `simp only [Bool.and_eq_true, decide_eq_true_eq]` + `obtain`/projection.

### Lean idiom improvements

- **`xs[i]!` analysis**: All `xs[i]!` usage in these files is in definitions
  (not proofs). Changing them to proven-bounds `xs[i]` would require
  restructuring definitions to capture bounds hypotheses (e.g., changing
  `if pos ≥ data.length` to `if h : pos < data.length`). This is a valid
  improvement but too invasive for a review session — it should be a separate
  implementation issue.

### Dead code / slop analysis

- Several `resolveLZ77_*` API lemmas (`resolveLZ77_endOfBlock_empty`,
  `resolveLZ77_literal_cons`, `resolveLZ77_reference_dist_zero`,
  `resolveLZ77_reference_dist_too_large`, `resolveLZ77_literals`) are
  defined but not currently used. However, they're characterizing properties
  of `resolveLZ77` — useful as API documentation and for future proofs.
  Per project rules, working theorems are not deleted.

- No unused imports found. All imports are necessary.

- Comment style is clean throughout — section markers and doc comments only.

### Self-improvement

- Added `Bool.and_eq_true` proof strategy to `.claude/CLAUDE.md`, documenting
  the left-associativity gotcha with `&&` after simp decomposition.

- Noted linter warnings in `DeflateEncode.lean` (unused simp args for `bind`,
  `Option.bind`, `Fin.val_mk`) — these are pre-existing and outside the
  review scope but should be addressed in a future review.

## Verification

- `lake build` passes
- `lake exe test` passes (all tests)
- Sorry count unchanged: 11 (0 in LZ77 module)
- No theorem statements modified
- Net line reduction: -28 lines

## What remains

- The `xs[i]!` → proven-bounds refactoring is a candidate for a future
  implementation issue
- DeflateEncode.lean linter warnings should be cleaned up in a future review
