# Progress: Gzip framing roundtrip infrastructure

**Date**: 2026-02-24T20:28 UTC
**Session**: ad0bf829 (worker, implementation)
**Issue**: #227

## What was accomplished

All 3 deliverables from the plan were completed:

1. **Pure single-member gzip decoder** (`GzipDecode.decompressSingle`):
   Proof-friendly decoder with no `for`/`while`/`mut`. Handles FLG=0
   streams only (matching what the encoder produces). Uses `Inflate.inflateRaw`,
   `Binary.readUInt32LE`, `Crc32.Native.crc32`.

2. **Gzip encoder format lemma** (`compress_header_bytes`, `compress_size`):
   Proved that `compress` output is `10 + deflated.size + 8` bytes, and
   the first 4 bytes are `[0x1f, 0x8b, 8, 0]`. Key proof technique:
   `rfl`-based size lemmas (`gzip_header_size`, `gzip_trailer_size`) that
   abstract over element values to avoid issues with `if` expressions
   in array literals (Lean can't compute `.size` of `#[..., if ... then
   ... else ..., ...]` directly).

3. **Gzip roundtrip theorem** (`gzip_decompressSingle_compress`, with sorry):
   States `decompressSingle (compress data level) = .ok data` for
   `data.size < 5000000`.

4. **Conformance tests**: `decompressSingle` tested against native encoder
   output (levels 0, 1, 5) and FFI encoder output.

## Proof patterns discovered

- **ByteArray literal size with symbolic elements**: `(ByteArray.mk #[a, b, ..., x, ...]).size`
  where `x` is an `if` expression doesn't reduce via `simp` or `decide`.
  Fix: prove `(ByteArray.mk #[..., x, ...]).size = N` as `rfl` by universally
  quantifying over the symbolic element (since `.size` only depends on the
  number of elements, not their values).

- **`getElem!_ba_append_left`**: Pattern for indexing into `(a ++ b)[i]!`
  when `i < a.size`. Uses `getElem!_pos` + `ByteArray.getElem_append_left`.
  This helper is duplicated from BinaryCorrect.lean (which has it as `private`).
  Could be factored out to a shared location in a future review session.

## Sorry count

- Start: 0
- End: 1 (the roundtrip theorem `gzip_decompressSingle_compress`)
- Delta: +1 (expected â€” the proof is planned for issue #230)

## Files created/modified

- `Zip/Spec/GzipCorrect.lean` (new, 91 lines)
- `Zip.lean` (added import)
- `ZipTest/NativeGzip.lean` (added conformance tests)
- `.claude/CLAUDE.md` (updated source layout)
