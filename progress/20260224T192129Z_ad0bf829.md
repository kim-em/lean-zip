# Progress: Review EmitTokensCorrect.lean

- **Date**: 2026-02-24T19:21Z
- **Session type**: review (proof quality + deduplication)
- **Issue**: #218

## Accomplished

### Deliverable 1: Deduplicate findTableCode_go helpers
- Made `findTableCode_go_idx_bound` and `findTableCode_go_extraN` public
  in `EmitTokensCorrect.lean`
- Removed duplicate private copies from `DeflateDynamicCorrect.lean` (3 theorems, ~28 lines)
- Unified naming: `native_findLengthCode_idx_bound` → `nativeFindLengthCode_idx_bound`,
  `native_findDistCode_code_bound` → `nativeFindDistCode_idx_bound`

### Deliverable 2: Proof quality in emitTokens_spec_go
- Combined consecutive `simp only` calls (LZ77Token.toLZ77Symbol + encodeLitLen)
- Simplified `htok_list` derivation with `▸` instead of `rw/exact`
- Inlined intermediate `h257` lemma
- Simplified `hlt_list` with `simpa`

### Deliverable 3: Proof quality in canonicalCodes section
- Simplified `fixedLitLengths_le_15` from 25 lines of manual case-splitting
  to 4 lines using `decide` (with `set_option maxRecDepth 4096`)
- Unified `canonicalCodes_size` and `canonicalCodes_size'` into single theorem
  with default `maxBits` parameter

### Bonus: Deduplicate array_get!Internal_eq
- Made `array_get!Internal_eq` public in `EmitTokensCorrect.lean`
- Removed duplicate private copies from `DeflateDynamicEmit.lean` and
  `DeflateDynamicHeader.lean`

## Metrics
- Files changed: 4
- Net line change: -64 (29 insertions, 93 deletions)
- `EmitTokensCorrect.lean`: 518 → 488 lines
- `DeflateDynamicCorrect.lean`: 838 → 809 lines
- Sorry count: 0 → 0 (no change)
- Build: passes
- Tests: all pass

## Notes
- The `simp only [htok/hflc/hfdc]` calls in `emitTokens_wf_go` are flagged
  by the unused simp args linter but are actually needed to reduce `match`
  expressions. Added comments explaining this.
- `fixedLitLengths_le_15` with `decide` requires `maxRecDepth 4096` due to
  the 288-element array (Fin 288 instance construction is deep).
