# Progress: Implement native Level 2 compressor with lazy LZ77

**Date**: 2026-02-23T10:21Z
**Session type**: implementation (worker)
**Issue**: #88

## What was accomplished

Implemented the native Level 2 DEFLATE compressor with lazy LZ77 matching:

1. **Factored `emitTokens` to top-level**: Extracted from `deflateFixed`'s
   `where` clause to a top-level `def` so both `deflateFixed` and `deflateLazy`
   can use it. Added `deflateFixedBlock` private helper for shared block
   framing logic. Updated proof reference in `DeflateFixedCorrect.lean`.

2. **Implemented `lz77Lazy`**: ~120 lines with duplicated helper functions
   (`hash3`, `countMatch`, `go`, `trailing`, `updateHashes`) in `where` block
   to avoid breaking existing `lz77Greedy` proofs. Uses explicit recursion with
   `termination_by data.size - pos` and `decreasing_by all_goals omega`.

3. **Implemented `deflateLazy`**: One-liner using `deflateFixedBlock` + `lz77Lazy`.

4. **Updated level dispatch**: `GzipEncode.compress`, `ZlibEncode.compress`, and
   `compressAuto` now route level ≥ 2 to `deflateLazy`.

5. **Added 9 conformance tests**: Native inflate roundtrip (hello, empty, single
   byte, repetitive, all-same, random), FFI cross-implementation (hello, big),
   and compression quality assertion (`deflateLazy ≤ deflateFixed` on repetitive).

6. **Stated `inflate_deflateLazy` theorem**: Sorry'd roundtrip theorem stub.

## Decisions

- **Duplicated helpers** rather than factoring `hash3`/`countMatch` to top-level.
  The plan noted factoring would break proofs in `LZ77NativeCorrect.lean` that
  reference `lz77Greedy.countMatch`. Duplication is ~30 lines and zero risk.
- **Factored `emitTokens`** because it's truly shared logic (same token format)
  and only one proof reference needed updating (`deflateFixed.emitTokens` →
  `emitTokens` in `DeflateFixedCorrect.lean`).

## Sorry count

- Start: 10 (4 DeflateFixedCorrect, 5 DeflateStoredCorrect, 1 HuffmanEncode)
- End: 11 (+1 `inflate_deflateLazy` theorem stub)

## What remains

- Prove `inflate_deflateLazy` (blocked on same dependencies as `inflate_deflateFixed`)
- Future: factor shared helpers between `lz77Greedy` and `lz77Lazy` if/when
  proving properties of `lz77Lazy` (will need corresponding correctness lemmas)
