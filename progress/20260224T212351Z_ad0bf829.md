# Progress: Zlib framing roundtrip infrastructure

**Date**: 2026-02-24T21:23:51Z
**Session type**: implementation (Phase 4+ — zlib framing roundtrip)
**Issue**: #232

## Accomplished

All deliverables from issue #232 completed:

### 1. Big-endian UInt32 byte roundtrip lemmas (BinaryCorrect.lean)
- Added `readUInt32BE_bytes`: proves inline big-endian read of 4 bytes reconstructs the original UInt32
- Added `readUInt32BE_append_right`: proves big-endian read from concatenated ByteArray at offset into right part
- Changed `ba4_getElem!_*` and `getElem!_append_{left,right}` from `private` to public for cross-file use

### 2. Pure single-stream zlib decoder + format lemmas (ZlibCorrect.lean)
- `ZlibDecode.decompressSingle`: pure zlib decompressor (no for/while/mut)
- `ZlibEncode.compress_size`: total size = 2 + deflated.size + 4
- `ZlibEncode.compress_cmf`: CMF byte is 0x78
- `ZlibEncode.compress_header_check`: (CMF*256 + FLG) % 31 == 0
- `ZlibEncode.compress_cm`: CM field is 8 (deflate)
- `ZlibEncode.compress_cinfo`: CINFO ≤ 7
- `ZlibEncode.compress_no_fdict`: FDICT bit not set
- All format lemmas proved (no sorry)

### 3. Zlib roundtrip theorem statement
- `zlib_decompressSingle_compress` stated with sorry
- Ready for proof in follow-up issue #233

### 4. Conformance tests
- Zlib decompressSingle tested against native encoder at levels 0, 1, 5
- Tested with empty, hello, single-byte, and large inputs
- Cross-checked against FFI encoder output

## Decisions
- Used `split <;> decide` pattern for case-splitting on flevel branches (4 concrete values per level range). `by_cases` creates awkward hypotheses for UInt8 Bool comparisons.
- Made `ba4_getElem!_*` and `getElem!_append_{left,right}` public (not protected) because they're used both within and outside the `Binary` namespace, and `protected` requires fully-qualified names even within the same namespace.

## Sorry count
- Start: 2 (both in GzipCorrect.lean)
- End: 3 (+1: zlib_decompressSingle_compress in ZlibCorrect.lean)

## Files changed
- `Zip/Spec/BinaryCorrect.lean` — added BE lemmas, made helpers public
- `Zip/Spec/ZlibCorrect.lean` — new file (127 lines)
- `Zip.lean` — added import
- `ZipTest/NativeGzip.lean` — added conformance tests
- `.claude/CLAUDE.md` — updated source layout
