# Progress: Implement native deflateDynamic (Level 5)

**Date**: 2025-02-23 15:19 UTC
**Session**: d59b4cb5 (worker)
**Issue**: #106

## What was accomplished

Implemented native DEFLATE compressor with dynamic Huffman codes (Level 5):

1. **`emitTokensWithCodes`**: Parameterized token emitter that takes
   arbitrary lit/len and distance code tables. Created as a standalone
   function (not refactoring `emitTokens`) to avoid breaking the
   recently proved `emitTokens_spec` theorem from PR #111.

2. **`tokenFreqs`**: Counts lit/len (0-285) and distance (0-29) symbol
   frequencies from LZ77 tokens, always including end-of-block (256).

3. **`writeDynamicHeader`**: Writes the dynamic Huffman tree header via
   BitWriter, reusing spec-level pure functions (`rlEncodeLengths`,
   `clSymbolFreqs`, `computeCodeLengths`, `computeHCLEN`, `clPermutation`)
   for the algorithmic logic while only handling bit output natively.

4. **`deflateDynamic`**: Composes greedy LZ77 + dynamic Huffman codes
   into a complete DEFLATE block (BFINAL=1, BTYPE=10). Handles the edge
   case where all distance codes are zero by setting a dummy code.

5. **Conformance tests**: 8 tests covering native inflate and FFI zlib
   inflate for hello, empty, single-byte, repetitive, all-same, random data.

6. **`inflate_deflateDynamic`**: Roundtrip theorem stated with sorry.

## Decisions

- Placed new code in `Zip/Native/DeflateDynamic.lean` rather than
  extending `Deflate.lean` (which would exceed 500 lines).
- Did NOT refactor `emitTokens` to wrap `emitTokensWithCodes` because
  `emitTokens_spec_go` (proved in PR #111) uses `unfold emitTokens`
  directly, and changing the definition would break the proof. The
  duplication is intentional and documented.

## Sorry count

- Start: 8 (5 DeflateFixedCorrect, 3 DeflateEncodeDynamic)
- End: 10 (+1 `inflate_deflateDynamic` theorem, +1 from "sorry" in docstring)
- Net new sorry tactics: 1 (as planned)

## What remains

- Prove `inflate_deflateDynamic` (requires dynamic block header
  correspondence + `emitTokensWithCodes` â†” spec bridge)
- Level 6-9 optimizations (different LZ77 strategies) are out of scope
