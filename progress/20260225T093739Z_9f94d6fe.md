# Progress: Review DecodeCorrect.lean

**Date**: 2026-02-25T09:37Z
**Session**: review (issue #277)
**Branch**: agent/9f94d6fe

## What was done

Reviewed `Zip/Spec/DecodeCorrect.lean` (710 lines, block-level DEFLATE
decode correctness proofs) for proof quality and code organization.

### Changes applied

1. **Extracted general-purpose lemmas to ZipForStd**:
   - `getElem?_eq_some_getElem!` → `ZipForStd/Array.lean` (was used in
     DecodeCorrect and DecodeComplete)
   - `push_data_toList` → `ZipForStd/ByteArray.lean`
   - `push_getElem!_lt` → `ZipForStd/ByteArray.lean`

2. **Reduced maxRecDepth settings**:
   - Table correspondence lemmas (`lengthBase_eq`, `distBase_eq`, etc.):
     1024 → 512
   - `decodeHuffman_correct`: 4096 → 2048

3. **Proof simplifications**:
   - Combined `rw [hbits] at hdb; rw [hdb'] at hdb` →
     `rw [hbits, hdb'] at hdb` in `decodeBits_eq_spec_decode`
   - Used `ByteArray.data_toList_length` instead of manual
     `simp [Array.length_toList, ByteArray.size_data]` (2 sites)
   - Removed `protected` from `symVal_of_beq` (used externally in
     DynamicTreesCorrect)
   - Removed redundant comment

4. **Result**: 710 → 690 lines. No sorry changes (was 0, still 0).

## Decisions

- Kept `ba_getElem!_eq_toList` private in DecodeCorrect: it relates
  `ba[j]!` to `ba.data.toList[j]!` (both `!`-variants), which differs
  from the existing `ByteArray.getElem!_toList` (which uses a proof on
  the RHS). Only used once internally, not worth a second ZipForStd lemma.
- Added `import ZipForStd.ByteArray` to DecodeCorrect — necessary for
  the extracted ByteArray lemmas. Clean import, no circular dependency.
- Did not attempt to extract shared patterns across the three block-type
  dispatch proofs (stored/fixed/dynamic): they are in different theorems
  (`decodeStored_correct` vs `decodeHuffman_correct`) with sufficiently
  different structure that abstraction would not reduce code.

## Verification

- `lake build`: pass (all 182 jobs)
- `lake exe test`: pass ("All tests passed!")
- Sorry count: 0 in DecodeCorrect (unchanged)
- Total sorry count: 1 (GzipCorrect.lean, unchanged)
