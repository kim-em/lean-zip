# 2026-02-19: Implementation — native backend integration (Phase 2 complete)

**Type**: implementation
**Phase**: Phase 2 (DEFLATE decompressor) — COMPLETE
**Sorry count**: 0 → 0

**Accomplished**:
- Integrated native pure-Lean decompressor as alternative backend for ZIP
  and tar.gz extraction, completing the final Phase 2 deliverable
- `Archive.extract`/`extractFile` now accept `useNative := true` to use
  `Zip.Native.Inflate.inflate` and `Crc32.Native.crc32` instead of C FFI
- Added `Tar.extractTarGzNative` for gzip decompression without C libraries
  (reads entire file into memory, O(file_size))
- Created `ZipTest/NativeIntegration.lean`: creates ZIP and tar.gz with FFI,
  extracts with native backend, verifies identical results for stored entries,
  deflated entries, empty files, and nested directories
- Fixed `maxEntrySize = 0` handling: FFI treats 0 as "no limit", native path
  caps at 256 MiB as zip-bomb guard (documented in docstring)

**Decisions**:
- ZIP integration is straightforward: entry data is already in memory
- Tar.gz native path is non-streaming (O(file_size) memory) because the
  native inflate works on complete ByteArrays. Streaming native inflate
  is future work
- Default `useNative := false` for backwards compatibility

**Codex review**:
- Flagged 256 MiB silent cap vs FFI "no limit" — addressed with docstring
- Flagged `Nat` overflow concerns — not applicable in Lean 4 (unbounded Nat)
- Suggested additional tests for CRC mismatch in native mode — deferred to
  review session (already covered in NativeGzip error tests)

**Next**:
- Review session for all Native/ code
- Phase 3: DEFLATE spec formalization
- Self-improvement session
