# Track C2: Fuel Audit and WF Recursion Prototype

**Date**: 2026-03-01 13:00 UTC
**Session**: feature (77e08376)
**Issue**: #318 — Track C2: audit fuel usage and prototype well-founded recursion

## Accomplished

### 1. Comprehensive Fuel Audit (`plans/track-c2-fuel-audit.md`)

Inventoried all fuel-based recursion across spec and native layers:

**Spec layer** (3 fuel-using functions):
- `decodeSymbols` — Huffman symbol decoding (leaf, default fuel 1e18)
- `decodeDynamicTables.decodeCLSymbols` — CL symbol decoding (leaf, fuel = totalCodes+1)
- `decode.go` / `decode.goR` — block loop (calls decodeSymbols)

**Native layer** (3 fuel-using functions):
- `Inflate.decodeCLSymbols` — mirrors spec version
- `Inflate.decodeHuffman.go` — mirrors spec decodeSymbols
- `Inflate.inflateLoop` — mirrors spec decode.go

Key finding: fuel is never passed between functions — each has its own
independent fuel pool, enabling independent conversion.

### 2. Conversion Order Identified

**Phase 1** (independent leaves): decodeCLSymbols (both), decodeSymbols, decodeHuffman
**Phase 2** (depends on Phase 1): decode.go/goR, inflateLoop
**Phase 3**: Update proofs (fuel independence becomes trivial/unnecessary)

### 3. Well-Founded Recursion Prototype (`Zip/Spec/DeflateWF.lean`)

Created `decodeCLSymbolsWF` using `termination_by totalCodes - acc.length`.
Validates:
- Termination proof works with `simp_all [List.length_append, List.length_replicate]; omega`
- Must use explicit `if/match` instead of `do` notation with `guard`
  so termination checker can extract guard conditions

## Decisions

- Chose `decodeCLSymbols` as prototype target: simplest decreasing measure,
  no fuel dependencies, guard directly provides termination condition
- Created WF version alongside existing fuel version rather than converting
  in-place: avoids updating 20+ files that reference `decodeDynamicTables.decodeCLSymbols`
- Omitted equivalence proof: aligning `do` notation (monadic bind chains)
  with explicit `match/if` is tedious; this friction disappears during
  actual in-place conversion when both sides share the same structure

## Quality Metrics

- Sorry count: 0 → 0 (no change)
- All tests pass
- No linter warnings

## What Remains

The actual conversion of all fuel functions is tracked for subsequent issues:
1. Convert leaf functions in-place (Phase 1)
2. Update all proofs that unfold converted functions
3. Remove fuel-independence theorems (no longer needed)
4. Convert block-level functions (Phase 2)
5. Update roundtrip theorems to remove fuel hypotheses
