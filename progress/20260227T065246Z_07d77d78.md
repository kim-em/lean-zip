# Progress: Prove last sorry — stored block case of deflateRaw_goR_pad

**Date:** 2026-02-27T06:52Z
**Session:** feature (07d77d78)
**Issue:** #308

## Accomplished

Proved the last remaining sorry in the lean-zip codebase: the stored
block case of `deflateRaw_goR_pad` in `DeflateRoundtrip.lean:82`.

**Sorry count: 1 → 0** across all `Zip/` files.

### Key additions to `Zip/Spec/Deflate.lean` (+292 lines)

1. **`decode.goR`** — variant of `decode.go` that returns both decoded
   data and remaining unprocessed bits (needed for padding analysis)

2. **`encodeStored_goR`** — proves `decode.goR (encodeStored data) acc
   fuel = some (acc ++ data, [])` by induction on the `encodeStored`
   recursion structure. The empty remaining `[]` is the key fact: stored
   blocks are byte-aligned.

3. **`bytesToBits_deflateStoredPure`** — connects the native ByteArray
   encoder (`deflateStoredPure`) to the spec-level bit-list encoder
   (`encodeStored`). Proves `bytesToBits (deflateStoredPure data) =
   encodeStored (List.drop pos data.data.toList)` for any starting
   position.

4. **`deflateStoredPure_goR`** — combines the above: `decode.goR
   (bytesToBits (deflateStoredPure data)) [] fuel = some
   (data.data.toList, [])`.

5. **Supporting lemmas**: `encodeLEU16` properties, `toUInt16_toNat`,
   `UInt16.toNat_xor`, `bytesToBits_storedHdr`, `encodeStored_non_final`.

### Other file changes

- **`DeflateStoredCorrect.lean`**: Made `storedBlockHdr` and
  `storedBlockHdr_size` public (removed `private`)
- **`DeflateSuffix.lean`**: Moved `decode.goR` to `Deflate.lean`
  (removed duplicate definition and its lemmas)
- **`DeflateRoundtrip.lean`**: Filled the sorry with a one-liner using
  `deflateStoredPure_goR`

## Decisions

- **Fuel bound**: Changed from `(data.size + 65534) / 65535` to
  `data.size / 65535 + 1`. The old bound was too weak for `data.size =
  0`: `(0 + 65534)/65535 = 0` but `0/65535 + 1 = 1` (need at least 1
  fuel for the single empty stored block).

- **`encodeStored_non_final` lemma**: Used `rw [encodeStored.eq_1]`
  (Lean 4's auto-generated equation lemma) for single-step unfolding of
  the WF-recursive `encodeStored`. `unfold` was too aggressive
  (recursively unfolds all occurrences).

## Quality metrics

- **Sorries**: 1 → 0
- **Build**: clean (0 errors, 0 warnings in proof files)
- **Tests**: all passing
