# Progress: 2026-02-24T18:39Z — ad0bf829

**Session type**: implementation (refactoring + test coverage)
**Issue**: #215 — Refactor: deduplicate level dispatch via deflateRaw + add conformance tests

## Accomplished

### All 3 deliverables completed

1. **Moved `deflateRaw` from `DeflateRoundtrip.lean` to `DeflateDynamic.lean`**
   - `DeflateDynamic.lean` already imports `Deflate.lean` and had a Spec import,
     so adding `deflateStoredPure` was natural
   - Couldn't go in `Deflate.lean` (plan's Option A) due to circular dependency:
     `DeflateDynamic` imports `Deflate`, and `deflateRaw` needs `deflateDynamic`
   - Roundtrip theorem stays in `DeflateRoundtrip.lean`

2. **Refactored Gzip.lean: replaced 3 copies of 4-way dispatch with `deflateRaw`**
   - `GzipEncode.compress`, `ZlibEncode.compress`, `compressAuto` all now call
     `Deflate.deflateRaw data level`
   - Removed redundant `import Zip.Native.Deflate` (transitive via DeflateDynamic)
   - Net: -22 lines, +3 lines

3. **Added `deflateRaw` conformance tests (12 test cases)**
   - Level 0/1/3/6 → native inflate
   - Level 6 → FFI inflate (cross-implementation, small + large)
   - Empty and single-byte edge cases at all 4 levels

## Decisions

- Chose to put `deflateRaw` in `DeflateDynamic.lean` rather than `Deflate.lean`
  because of the circular dependency. This is clean since DeflateDynamic already
  has a Spec import and is the "final" native compressor file.
- The stored path in gzip/zlib now uses `deflateStoredPure` (the proved version)
  instead of `deflateStored` (the imperative version). Both produce valid stored
  blocks; the proved version is better since `inflate_deflateRaw` covers it.

## Verification

- `lake build`: pass
- `lake exe test`: all tests pass
- Sorry count: 0 (unchanged)
- No duplicate dispatch: `grep -c 'deflateStored\|deflateFixed\|deflateLazy\|deflateDynamic' Gzip.lean` = 0
