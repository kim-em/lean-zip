# 2026-02-19: Review — Phase 2 DEFLATE decompressor

**Type**: review
**Phase**: Phase 2 (DEFLATE decompressor) — in progress
**Sorry count**: 0 → 0

**Reviewed**:
- `Zip/Native/BitReader.lean`: Clean, minimal, no issues. Bounds checks
  protect all `!` indexing. `readBits` n ≤ 25 precondition documented but
  not enforced — acceptable for internal API.
- `Zip/Native/Inflate.lean`: Thorough review against RFC 1951. All code
  paths correct: canonical Huffman construction (§3.2.2), fixed codes
  (§3.2.5), dynamic codes (§3.2.7), stored blocks (§3.2.4), LZ77
  back-reference with overlapping copy. Length/distance tables verified.
- `ZipTest/NativeInflate.lean`: Good coverage (all levels, empty, single
  byte, large, pseudo-random). No critical gaps.

**Fixes applied**:
- **Security**: Added `maxOutputSize` parameter (default 256 MiB) to
  `inflate`, `decodeStored`, and `decodeHuffman` to guard against zip bombs
- **Robustness**: Converted `while !isFinal` to bounded `for _ in [:10001]`
  loop, eliminating `isFinal` and `blockCount` mutable variables
- **Style**: Replaced `List.range n` with `[:n]` ranges (4 occurrences
  across Inflate.lean, Helpers.lean, Archive.lean)
- Fixed fuel exhaustion error message ("fuel limit" vs "size limit")

**Toolchain**: v4.29.0-rc1 is current (latest stable: v4.28.0, released
2026-02-16). No upgrade needed.

**Not changed** (acceptable as-is):
- `HuffTree.insert` catch-all for leaf nodes (returns leaf unchanged) —
  only reachable with invalid data, and the error surfaces later in decode
- `!` indexing throughout — all uses are bounds-safe, but converting to
  proof-carrying indexing is future work for Phase 3

**Next**:
- Gzip/zlib framing layer (headers, trailers, checksums)
- DEFLATE spec formalization
- Error-case tests for inflate
