# Progress: Review proof quality in DecodeComplete.lean

**Date**: 2026-02-25T01:21Z
**Session type**: review
**Issue**: #256

## Accomplished

### 1. Extracted `getElem?_some_eq_getElem!` helper
Deduplicated 4 identical 3-line patterns that bridge `arr[i]? = some val`
to `val = arr[i]!` via `getElem?_eq_some_getElem!`. Each call site now
uses a single term-mode application.

### 2. Removed unused `hlen_bound` parameter from `huffTree_decode_complete`
The `lengths.size ≤ UInt16.size` parameter was unused in the proof body
(linter warning). Removed it and propagated the change to all 3 callers:
- `decodeHuffman_complete` (DecodeComplete.lean, 2 call sites)
- `decodeCLSymbols_complete` (DynamicTreesComplete.lean, 1 call site)
- `decodeDynamicTrees_complete` (InflateComplete.lean, 1 call site — also
  removed now-unused `hcl_sz_u16` intermediate binding)

### 3. Reduced `maxRecDepth` settings
- `decodeLitLen_reference_inv`: 4096 → 1024
- `hlz'` in reference branch: 2048 → 1024

Both still build without issues at 1024.

### 4. Simplified `hextra_le`/`hdextra_le` proofs
Replaced 8-line tactic proofs with 3-line term-mode `▸` rewrites,
chaining the correspondence and bound lemmas directly.

### 5. Assessed decodeLitLen deduplication (not applied)
Investigated whether `decodeLitLen_reference_inv` and
`decodeLitLen_ge257_isReference` could share code. Conclusion: not
net-positive. They share the same 8-deep case chain structure but extract
fundamentally different information (existence of `.reference` vs all
intermediate values). A combined theorem would have a very large conclusion
type and not improve readability. The overlap is structural, not logical.

## Decisions

- Kept `decodeLitLen_ge257_isReference` separate from `decodeLitLen_reference_inv`
- Used term-mode `▸` for the `extra ≤ 32` proofs but kept tactic mode for
  `hnative_extra_eq`/`hnative_dextra_eq` (term mode hits maxRecDepth there)

## Files changed

- `Zip/Spec/DecodeComplete.lean` — main review target (691 → 677 lines)
- `Zip/Spec/DynamicTreesComplete.lean` — parameter removal propagation
- `Zip/Spec/InflateComplete.lean` — parameter removal + dead code cleanup

## Verification

- `lake build`: pass (all 180 jobs)
- `lake exe test`: pass (all tests)
- Sorry count: 3 (unchanged — 1 GzipCorrect, 2 ZlibCorrect)
- DecodeComplete.lean sorry count: 0 (unchanged)
