# Review: DeflateStoredCorrect.lean proof quality

**Date**: 2026-02-26 22:55 UTC
**Session**: d3dfa774 (review)
**Issue**: #310

## What was accomplished

Reviewed `Zip/Spec/DeflateStoredCorrect.lean` (748 lines, 0 sorries) for
proof quality. This file contains the stored block roundtrip correctness
proof: `inflate (deflateStoredPure data) = .ok data`.

### Changes made

1. **Removed unused import**: `import Zip.Native.Deflate` was not referenced
   anywhere in the file.

2. **Removed dead code**: `have hrb := readBytes_at_aligned ...` on line 193
   was declared but never used â€” `hrb'` (same lemma with `brPos + 2 + 2`
   instead of `brPos + 4`) was the one actually applied.

3. **Merged consecutive simp calls**: Two `simp only` calls in
   `decodeStored_on_block` (NLEN check + pure reduction) combined into one.

4. **Fixed linter warnings**: Replaced `simp only [bind, Except.bind]` with
   `dsimp only [bind, Except.bind]` in 4 locations. These calls normalize
   monadic bind expressions and are necessary for the proof, but `simp` was
   reporting `bind` and `Except.bind` as "unused" arguments (false positive
   from the `unusedSimpArgs` linter). Using `dsimp` is more precise (only
   definitional simp) and doesn't trigger the linter.

5. **Removed linter suppressions**: Deleted two `set_option linter.unusedSimpArgs
   false` annotations that were no longer needed after the `dsimp` fix.

6. **Combined rw steps**: Merged `rw [readBits_2_at_1 ...]; rw [hhdr]` into
   `rw [readBits_2_at_1 ..., hhdr]` in both `inflateLoop_final_stored` and
   `inflateLoop_nonfinal_stored`.

### What was NOT changed

- `maxRecDepth 4096` / `maxHeartbeats 1600000` on `fromLengths_fixedLit_ok`:
  needed for `decide` on 288-element arrays, can't be reduced without
  significant experimentation.
- The inline `by` proof blocks in `inflateLoop_deflateStored`: extracting
  repeated subproofs into `have` bindings triggers kernel deep recursion.
  The current inline structure is carefully optimized to avoid this.
- No lemmas were general enough for ZipForStd extraction.

## Metrics

| Metric | Before | After |
|--------|--------|-------|
| Lines | 748 | 733 |
| Sorries | 0 | 0 |
| Linter warnings | 4 | 0 |
| Build time | ~13s | ~8.4s |

## Decisions

- `dsimp only` is the right tool for monadic bind normalization in this
  codebase. It's more precise than `simp only` and avoids false-positive
  linter warnings. This pattern should be adopted elsewhere.
- Extracting `have` bindings from deeply nested proof terms risks kernel
  deep recursion. The existing inline style is intentional and should be
  preserved.

## What remains

- The file is now clean. No further review work needed.
