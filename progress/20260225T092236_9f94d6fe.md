# Progress: Iterative LZ77 greedy matcher

- **Date**: 2026-02-25 09:22 UTC
- **Session type**: feature (Track D)
- **Issue**: #288
- **Branch**: agent/9f94d6fe

## Accomplished

All deliverables from issue #288 completed:

1. **`lz77GreedyIter`** — Tail-recursive, Array-accumulating version of `lz77Greedy`.
   `mainLoop` and `trailing` accumulate into an `Array LZ77Token` parameter
   instead of building `List LZ77Token` via cons. Eliminates stack overflow on
   inputs >50KB. Duplicates `where` helpers (hash3, countMatch, go, updateHashes,
   trailing) as the plan suggested.

2. **`deflateFixedIter`** — Wraps `lz77GreedyIter` + `deflateFixedBlock`. Kept
   `deflateFixed` unchanged to preserve existing proofs. Updated `deflateRaw`
   (in DeflateDynamic.lean) to dispatch level 1 to `deflateFixedIter`.

3. **Bridge theorem** — Added `lz77GreedyIter_eq_lz77Greedy` (sorry) in
   DeflateFixedCorrect.lean, and `inflate_deflateFixedIter` derived from it.
   Updated DeflateRoundtrip.lean to use the new theorem.

4. **Conformance tests** — lz77GreedyIter matches lz77Greedy on 7 small inputs.
   deflateFixedIter roundtrips via native inflate and FFI inflate on 256KB+.
   deflateRaw level 1 roundtrips 256KB.

5. **Benchmark update** — Split size/level matrix: small sizes (1–32KB) test all
   levels (0, 1, 6); large sizes (64–256KB) test only levels 0 and 1. Compression
   ratio table now includes 256KB entries.

## Decisions

- Created `deflateFixedIter` alongside `deflateFixed` instead of modifying
  `deflateFixed` directly. This avoids breaking `deflateFixed_spec` and
  `inflate_deflateFixed` which structurally depend on `lz77Greedy`.
- Added `deriving BEq, Inhabited` to `LZ77Token` for test comparisons.
- The sorry for `lz77GreedyIter_eq_lz77Greedy` is the expected placeholder
  noted in the issue plan. A future session should prove this equivalence.

## Sorry count

- Start: 3 (GzipCorrect:2, ZlibCorrect:1)
- End: 4 (GzipCorrect:2, ZlibCorrect:1, DeflateFixedCorrect:1)
- Delta: +1 (new placeholder for lz77GreedyIter_eq_lz77Greedy)

## What remains

- Prove `lz77GreedyIter_eq_lz77Greedy` (eliminate the sorry)
- Write `lz77LazyIter` for lazy matcher (same pattern, enables levels 2-4 at
  large sizes)
- Consider `lz77GreedyIter` for `deflateDynamic` (currently uses `lz77Greedy`)
