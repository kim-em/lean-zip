# Progress: Review Native/ and ZipForStd/ code quality

- **Date**: 2026-02-24T07:30Z
- **Session**: 7a76d03c (worker — review)
- **Issues**: #165 (closed — merge conflict fix), #161 (review)

## Accomplished

### Issue #165: Fix merge conflicts on PR #164
Rebased PR #164 onto master, resolving conflicts from PR #162 and #155.
PR is now MERGEABLE — auto-merge will complete once CI passes.

### Issue #161: Review Native/ and ZipForStd/ code quality

**Audit of `[i]!` patterns across Native/ (67 instances)**:
- Most `[i]!` instances in Native/ are in functions referenced by proofs
  (DecodeCorrect, InflateCorrect, DeflateFixedCorrect, etc.). Converting
  to proven-bounds access would change the term structure after `unfold`
  and break these proofs.
- `do` block guards (`if cond then throw`) don't produce hypotheses
  for the continuation, so bounds can't be proven without restructuring.
- **1 conversion applied**: `detectFormat` — used `if h : data.size ≥ 2`
  to capture the bound, replacing `data[0]!`/`data[1]!` with `data[0]`/`data[1]`.
  Also eliminated a redundant size check.

**Dead code audit**: No dead code or unused imports found across all 8
Native/ files. All functions and imports are actively used.

**`writeCLEntries` cleanup**: Removed unused `i : Nat` parameter that was
incremented but never read. Termination is structural on `entries`.

**ZipForStd/ stale lemma check**: All 5 lemmas still needed:
- `Array.getElem!_set!_ne` / `_self` — std has `getElem_set_ne`/`_self`
  for bounds-checked variants but NOT for `!` variants
- `List.foldl_add_init` / `foldl_count_init` — std's `foldl_assoc` and
  `foldl_hom` don't cover these specific patterns
- `Nat.or_two_pow_eq_add` — not in std

## Key findings

- **`[i]!` in proof-connected code is load-bearing**: The `!` variant is
  part of the function's term, and proofs that `unfold` the function see
  it. Converting to `[i]` changes the desugared term and breaks all
  downstream proofs. This is a structural constraint, not a laziness issue.
- **`do` block guard pattern prevents proven-bounds**: The `if ... then throw`
  pattern in `Except` do-notation doesn't produce a hypothesis for omega.
  Converting would require `if h : ... then throw` at every guard.
- **Recommendation**: Future `[i]!` → `[i]` conversions should happen
  simultaneously with proof updates, not as a separate review concern.

## Sorry count

- Start: 8
- End: 8
- Delta: 0 (review session — no proof changes)
