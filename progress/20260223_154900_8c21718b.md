# Progress Entry — 2026-02-23 15:49 UTC

**Session**: 8c21718b (worker, continuation)
**Issue**: #84 — Prove inflate_deflateFixed — Level 1 end-to-end roundtrip
**Branch**: agent/8c21718b
**Starting commit**: 7b71675
**Starting sorry count**: 10 (7 in DeflateFixedCorrect.lean, 3 in DeflateEncodeDynamic.lean)

## Accomplished

Proved `findLengthCode_agree` and `findDistCode_agree` — the two sorry'd
helper lemmas blocking the `emitTokens_spec` proof chain.

### Key changes

1. **Zip/Native/Deflate.lean**: Extracted `findTableCode.go` from a
   `where` clause to a top-level `def` for cross-file accessibility.
   `where`-clause helpers are not accessible from other files even when
   the parent function is public.

2. **Zip/Spec/DeflateEncode.lean**: Added `findLengthCode_upper` and
   `findDistCode_upper` public theorems that expose the upper bound
   (`len < lengthBase[idx+1]!`) from the private `_go_spec` lemmas.

3. **Zip/Spec/DeflateFixedCorrect.lean**:
   - Proved `findTableCode_go_of_first_match` by induction on table
     size, showing the native linear search returns the expected result
     given matching/skipping conditions.
   - Proved `findLengthCode_agree` and `findDistCode_agree` using table
     correspondence (`nativeLengthBase_eq` etc.), monotonicity, and
     the new upper bound theorems.
   - Removed false `lengthBase_gap_ge` and `distBase_gap_ge` lemmas
     (the proposition is false at index 27 because DEFLATE length code
     285 only maps to length 258 exactly, making the gap 31 < 2^5 = 32).

## Decisions and patterns discovered

- **`subst` direction matters**: `subst heq` where `heq : i = idx`
  eliminates `idx` (right-side variable first in Lean 4), making `idx`
  unknown. Fix: use `by_cases heq : idx = i` to eliminate `i` instead.

- **`where`-clause accessibility**: Even after making a parent function
  non-private, `where`-clause helpers (e.g., `findTableCode.go`) are
  not accessible from other files. Must extract to top-level defs.

- **Upper bound wrapping pattern**: When a private theorem provides
  needed info, add a public wrapper that extracts just that fact,
  rather than making the full private theorem accessible.

## What remains

Sorry count: 8 (5 in DeflateFixedCorrect.lean, 3 in DeflateEncodeDynamic.lean)

The 5 remaining sorries in DeflateFixedCorrect.lean are:
1. `deflateFixed_spec` — bitstream-level: deflateFixed output = spec encode
2. `inflate_complete` — reverse direction: spec decode → native inflate
3. `inflate_deflateFixed` — Level 1 roundtrip
4. `inflate_deflateLazy` — Level 2 roundtrip
5. `inflate_deflateDynamic` — Level 5 roundtrip

These are deeper architectural proofs requiring BitWriter flush
correspondence and inflate completeness (the reverse of inflate correctness).

## Verification

- `lake build`: passes (25 lean jobs)
- `lake exe test`: all tests pass
- Sorry delta: -2
