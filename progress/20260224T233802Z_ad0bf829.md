# Progress: Review — DynamicTreesCorrect proof deduplication

**Date**: 2026-02-24T23:38Z
**Session type**: review (proof quality + deduplication)
**Issue**: #240

## Accomplished

### 1. Moved utility lemmas to ZipForStd
- `take_set_succ` → `ZipForStd/List.lean` (generalized from `UInt8` to `α`)
- `extract_set_map_append` → `ZipForStd/Array.lean`
- `extract_map_getLast_eq` → `ZipForStd/Array.lean`
- Added `import ZipForStd.List` to `ZipForStd/Array.lean` (needed by `extract_set_map_append`)
- Updated all references in `DynamicTreesCorrect.lean`, `DynamicTreesComplete.lean`

### 2. Combined `decodeCLSymbols_inv` + `decodeCLSymbols_size`
- Merged into single `decodeCLSymbols_inv` returning `∧` of all three properties:
  bitOff well-formedness, position invariant, array size preservation
- Changed visibility from `private` to `protected` (needed by `InflateComplete.lean`)
- Moved `fillEntries_*` helpers before the combined theorem (dependency ordering)
- Updated use sites in `decodeDynamicTrees_correct` and `InflateComplete.lean`

### 3. Eliminated `maxRecDepth 4096`
- Root cause: `▸` on lines 673, 678 triggered full `whnf` on UInt8 expressions
- Fix: replaced `hlit_take ▸ hlit_valid` with `by rw [hlit_take]; exact hlit_valid`
- Default `maxRecDepth` (1024) now suffices

## Metrics
- **Line count**: 788 → 695 (−93 lines, 12% reduction)
- **Sorry count**: 10 → 10 (unchanged)
- **maxRecDepth**: 4096 → eliminated
- **Theorem statements**: unchanged (refactor only)

## Key insight
The `▸` tactic is particularly expensive on dependent types involving UInt8/BitVec
because it normalizes the entire goal. `rw` + `exact` is a targeted replacement
that avoids this cost entirely.
