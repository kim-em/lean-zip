# Progress: Prove decodeHuffman_complete length/distance case

- **Date**: 2026-02-24 10:17 UTC
- **Session**: 8be686d0 (worker, implementation)
- **Issue**: #168

## What was accomplished

Proved the length/distance (back-reference) case of
`decodeHuffman_complete` in `Zip/Spec/DecodeCorrect.lean`, removing
the last sorry in that file.

This is the completeness direction of block-level decode correctness:
if the spec `decodeSymbols` succeeds with a `.reference len dist`
symbol and `resolveLZ77` produces output, then the native
`decodeHuffman.go` also succeeds and produces the same output.

## Key proof patterns

- **Fin coercion mismatch with omega**: The `decide`-proved table
  correspondence lemmas (`lengthBase_eq`, `lengthExtra_eq`, etc.)
  take `Fin` arguments. When applied as `lemma ⟨k, hk⟩`, omega
  treats `arr[(⟨k, hk⟩ : Fin n).val]!` and `arr[k]!` as different
  variables. Fix: explicitly annotate the `have` result type to
  match the goal's form, e.g.:
  ```lean
  have : (Inflate.lengthExtra[sym_nat - 257]!).toNat =
      Spec.lengthExtra[sym_nat - 257]! :=
    lengthExtra_eq ⟨sym_nat - 257, hidx⟩
  ```

- **UInt16.toNat 256 opaque to omega**: After `simp only
  [UInt16.lt_iff_toNat_lt, hsym_toNat]`, the goal contains
  `UInt16.toNat 256` which omega can't evaluate. Use `show` to
  replace with the literal: `show ¬(sym_nat < 256); omega`.

- **hidx_ok must match post-rewrite goal**: When `hsym_toNat`
  rewrites `sym_nat.toUInt16.toNat` to `sym_nat` in the goal,
  `hidx_ok` must be stated in terms of `sym_nat` (not
  `sym_nat.toUInt16.toNat`) for simp to apply it.

- **copyLoop rewrite max recursion**: `rw [hcopy_native]` on a
  goal involving `List.ofFn (fun (i : Fin len) => ...)` hits max
  recursion depth. Fix with `set_option maxRecDepth 2048 in`.

- **Bool.false_eq_true for stuck `if`**: After beq reduces to
  `false`, the `if false = true then ...` condition needs
  `Bool.false_eq_true` + `↓reduceIte` to fully reduce.

## Sorry count

- Start: 6 (1 DecodeCorrect, 3 DeflateFixedCorrect, 2 InflateCorrect)
- End: 5 (0 DecodeCorrect, 3 DeflateFixedCorrect, 2 InflateCorrect)
- Delta: -1

## Deliverables

- [x] Prove length/distance case of `decodeHuffman_complete`
- [x] Zero sorry in `DecodeCorrect.lean`
- [x] `lake build` passes
- [x] `lake exe test` passes
