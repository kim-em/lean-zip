# Progress: Review — DecodeCorrect.lean and DynamicTreesCorrect.lean

**Date**: 2026-02-23T22:00 UTC
**Session**: 1e49a912
**Type**: review (refactoring and proof improvement)
**Issue**: #50

## What was done

Deep review of proof quality in `Zip/Spec/DecodeCorrect.lean` (707 lines)
and `Zip/Spec/DynamicTreesCorrect.lean` (824 lines). Focus areas:
proof minimization and reusable lemma extraction.

### Improvements applied

1. **Extracted `symVal_of_beq` helper** (DecodeCorrect.lean, shared):
   Converts `(sym == n) = true` for UInt16 to `sym.toNat = n.toNat`.
   Previously 3 copies (2-line proof each) in DynamicTreesCorrect plus
   1 in DecodeCorrect. Now a single `protected` definition in
   DecodeCorrect used by both files.

2. **Extracted `accLen_eq_min` helper** (DynamicTreesCorrect.lean):
   Proves `(codeLengths.extract 0 idx).toList.map ... .length = min idx
   codeLengths.size`. Previously 4 identical 4-line proof blocks in
   `decodeCLSymbols_correct`. Now a single lemma with 1-line invocations.

3. **Combined complement check proofs** (DecodeCorrect.lean):
   `hcomp_eq` + `hcomp_nat` chain in `decodeStored_correct` reduced from
   4 lines to 3 by inlining intermediate result.

4. **Fixed unused simp arg lint warning** (DynamicTreesCorrect.lean):
   Removed unused `pure` from simp argument list.

5. **Consolidated `simp only + simp` into single `simp`**
   (DynamicTreesCorrect.lean): Two-step simp chain in
   `decodeDynamicTrees_correct` reduced to one.

### Line count changes

| File | Before | After | Delta |
|------|--------|-------|-------|
| DecodeCorrect.lean | 707 | 709 | +2 |
| DynamicTreesCorrect.lean | 824 | 817 | -7 |
| **Total** | **1531** | **1526** | **-5** |

DecodeCorrect grew by 2 lines due to the new shared `symVal_of_beq`
helper (4 lines added, 2 lines saved).

### What was reviewed and found acceptable

- Table correspondence lemmas (`lengthBase_eq`, etc.): Already minimal
  (`by decide` with appropriate `maxRecDepth`). No improvement possible.
- `decodeBits_eq_spec_decode`: Well-structured, no redundancy found.
- `huffTree_decode_correct`: Clean 2-step proof. The `decode.go`
  unwrapping pattern (3 occurrences) could share a helper but net savings
  would be ~0 lines.
- `decodeStored_correct`: Systematic do-notation unfolding. Clean.
- `decodeHuffman_correct`: The `sym.toNat >= 257` proof (5 lines) was
  investigated for simplification but the UInt16/Nat conversion makes
  shorter versions fail. Left as-is.
- Invariant propagation theorems (`_wf`, `_pos_inv`, `_size`): Structurally
  parallel but each proves different properties. Not worth combining.
- sym==17 and sym==18 cases in `decodeCLSymbols_correct`: Nearly identical
  structure but differ in 3 constants (readBits count, offset, fill value).
  A parameterized helper could save ~30 lines but would require careful
  design. Noted for future consideration.

### DynamicTreesCorrect size assessment

At 817 lines, the file is in the caution zone but not critical. A natural
split point exists between the `fromLengths_valid` + helper lemmas
(general HuffTree properties, ~340 lines) and `decodeDynamicTrees_correct`
(DEFLATE-specific, ~480 lines). Not urgent — can be done when the file
next needs significant additions.

## Sorry count

Unchanged: 4 total (2 in Deflate.lean, 2 in LZ77NativeCorrect.lean).
No sorries in the reviewed files.

## Decisions

- Made `symVal_of_beq` `protected` (not `private`) since it needs
  cross-file access from DynamicTreesCorrect.
- Did not split DynamicTreesCorrect — 817 lines is below the 1000-line
  hard limit and splitting would be better done alongside new additions.
