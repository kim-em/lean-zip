# Progress: Prove gzip suffix invariance chain (session 9f94d6fe)

**Issue**: #276 — Prove gzip_decompressSingle_compress roundtrip
**Type**: feature (continuation of previous session)
**Branch**: `agent/9f94d6fe`

## Summary

Proved the complete suffix invariance chain for gzip DEFLATE decoding,
reducing GzipCorrect.lean from 3 sorrys to 2. All intermediate suffix
invariance lemmas are now fully proved.

## Deliverables

### Proved lemmas (all new, no sorry)

1. **decodeCLSymbols_append**: Induction on fuel with by_cases for all
   CL symbol types (literal < 16, repeat == 16, zero-short == 17,
   zero-long == 18). Chains huffDecode_append and readBits_append.

2. **decodeDynamicTrees_append**: Chains readBits_append (x3),
   readCLCodeLengths_append, decodeCLSymbols_append through the full
   dynamic tree pipeline. Pure HuffTree.fromLengths passes through.

3. **decodeHuffman_go_append**: The hardest lemma — deeply nested
   monadic structure with literal/end-of-block/length-distance branches.
   Uses `set_option maxRecDepth 4096` for `simp only [bind, Except.bind]`.
   Previous session failed 3 times on this; succeeded with cleaner
   `by_cases`/`if_pos`/`if_neg` pattern.

### Proof technique discoveries

- After `cases` on `HuffTree.fromLengths`, the goal's match is already
  reduced — only apply `simp only [hft_eq]` to hypothesis `h`, not `⊢`
- `simp only [pure, Except.pure]` sometimes makes no progress when
  `rw [if_neg ...]` already normalized — remove rather than debug
- `dsimp only []` after `rw [foo_append ...]` is needed to reduce
  `match Except.ok x with ...` — but NOT after `simp only [pure, ...]`
  which already does this reduction

## Remaining sorrys

**2 sorrys in main theorem** (hcrc, hisize): Both require
`endPos = compressed.size - 8`, which needs endPos tracking
infrastructure. Same blocker as ZlibCorrect.lean (2 sorrys there too).
This is an infrastructure gap, not a proof difficulty.

## Sorry count

- GzipCorrect.lean: 3 → 2 (proved hendPos_tight + all intermediates)
- Global Spec/ sorry count: 4 (2 Gzip + 2 Zlib, all same blocker)

## Build status

- `lake build`: passes (0 errors, 2 sorry warnings in GzipCorrect)
- `lake exe test`: all tests pass
