# Progress: Review BitWriterCorrect + BitstreamWriteCorrect

**Date**: 2026-02-25T04:35Z
**Session type**: review
**Issue**: #263

## Accomplished

### BitWriterCorrect.lean (431 → 398 lines, ~7.7% reduction)

1. **Extracted `or_shiftLeft_lt_two_pow` helper**: The proof that
   `buf ||| (bit <<< k) < 2 ^ (k + 1)` was duplicated identically in
   `addBit_toBits` and `addBit_wf`. Extracted as a shared private lemma,
   cutting ~20 lines of duplicated calc blocks.

2. **Unified `by_cases` branches in `writeHuffCode_go_spec`**: The positive
   and negative flush branches were identical. Replaced with
   `by_cases ... <;> · first | rw [if_pos] | rw [if_neg]; ...` pattern.

3. **Hoisted `hhead`/`htail` in `writeBits_go_spec`**: These two lemmas
   were duplicated in both flush branches. Moved above the case split,
   then unified branches with the same `first | rw [if_pos] | rw [if_neg]`
   pattern.

4. **Simplified `range_map_extend`**: Replaced verbose intermediate `have`
   steps with direct `rw` + `simp only` chains.

### BitstreamWriteCorrect.lean (292 lines, minimal changes)

1. **Simplified `bitsToNat_bound` nil case**: Replaced verbose
   `Nat.pos_of_ne_zero (by simp [Nat.pow_eq_zero])` with direct simp call.

The file was already well-structured with clean proofs. No significant
duplication or improvement opportunities beyond the minor simplification.

## Review observations (no action needed)

- `uint16_extract_bit` and `uint32_extract_bit` have parallel structure
  but operate on different types; abstracting would require type-class
  machinery that's not worth the complexity.
- `bitsToNat` properties in BitstreamWriteCorrect are specific to the
  `Deflate.Spec` definitions and belong here, not in ZipForStd.
- No `maxHeartbeats` or `maxRecDepth` settings in either file.
- Both files have accurate module docstrings.
- No overlap between read-side (BitstreamCorrect) and write-side
  (BitstreamWriteCorrect) — they cover complementary directions.

## Metrics

- Sorry count: 3 → 3 (unchanged)
- Starting commit: 3f21f4c
- Build: pass, all tests pass
