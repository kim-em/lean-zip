# Progress: Review — proof refactoring in HuffmanCorrect.lean

**Date**: 2026-02-24 06:50 UTC
**Session type**: review (refactoring and proof improvement)
**Issue**: #158

## Accomplished

### Deliverable 1: Proof audit and improvements (target: 10+)

Applied 12 concrete improvements:

1. **Created `ZipForStd/Array.lean`** with generic `getElem!_set!_ne` and
   `getElem!_set!_self` — replaces 4 type-specific duplicates (UInt32, pair)
   across HuffmanCorrect and HuffmanEncodeCorrect
2. **Made `codeFor_some` public** — was private and duplicated in both files
3. **Made `count_foldl_take_le` public** — was private, duplicated as inline
   proof in insertLoop_backward
4. **Extracted `nc_invariant_step`** — the NC invariant update proof block
   (~25 lines) was duplicated in insertLoop_forward and insertLoop_backward;
   now a shared lemma called from both
5. **Replaced inline `h_partial_le` proof** in insertLoop_backward with
   `count_foldl_take_le` call (eliminated 12-line inline duplicate)
6. **Replaced inline `h_partial_le` proof** in HuffmanEncodeCorrect with
   `count_foldl_take_le` call
7. **Removed dead `hlen_pos_nat` bindings** — defined but never referenced
   in both insertLoop_forward and insertLoop_backward
8. **Simplified `hls_val` proof** — collapsed 5-line verbose block to 2 lines
   (×2 occurrences in forward and backward)
9. **Simplified `hs` proof** in fromLengths_hasLeaf — 3 lines → 1 line
10. **Simplified `hk_small` proof** in fromLengths_leaf_spec — 4 lines → 1 line
11. **Simplified skip-case forward invariant** — removed verbose comments,
    collapsed `by_cases` + `exfalso` to more direct `absurd`
12. **Removed all duplicate helpers from HuffmanEncodeCorrect** — 37 lines of
    duplicated array/codeFor helpers deleted

### Deliverable 2: File split evaluation

At 796 lines (down from 835), HuffmanCorrect.lean is within limits. Natural
split point exists (insert layer vs fromLengths layer) but neither half would
be under 300 lines, so the split adds overhead without clear readability gain.
Decision: leave as-is.

### Deliverable 3: Newer tactics

Checked for opportunities to use `grind` and `omega` more aggressively.
Most existing proofs already use `omega` effectively. The `simp_all` and
`cases b <;> simp_all` patterns are already concise. No new `grind`
opportunities found — the proofs are primarily structural (tree induction,
case splits) rather than algebraic.

## Metrics

- HuffmanCorrect.lean: 835 → 796 lines (-39)
- HuffmanEncodeCorrect.lean: 386 → 340 lines (-46)
- New: ZipForStd/Array.lean (22 lines)
- Net: -65 lines removed, +22 lines added = -43 lines total
- Sorry count: unchanged (9 total)
- Build: passes
- Tests: all pass

## Decisions

- Generic `Array.getElem!_set!_ne`/`_self` chosen over type-parameterized
  versions — the proofs are identical regardless of element type
- `codeFor_some` made fully public (not `protected`) because it's used
  unqualified within the same namespace AND needed by HuffmanEncodeCorrect
- NC invariant extraction uses `private` since it's only needed within
  HuffmanCorrect.lean (both callers are in the same file)
