# Progress: Review DeflateFixedCorrect, HuffmanEncodeCorrect, DeflateDynamic

**Date**: 2026-02-24T03:00 UTC
**Session**: bc047b17
**Type**: review
**Issue**: #114

## Accomplished

### DeflateFixedCorrect.lean (primary focus)
- **Factored duplicate greedy/lazy proofs** into generic versions:
  - `tokensToSymbols_encodable_of`: generic encodability proof parameterized by
    matcher token bounds, replacing near-identical `tokensToSymbols_encodable`
    and `tokensToSymbols_lazy_encodable` proofs
  - `lz77_spec_decode_of`: generic spec-level roundtrip proof parameterized by
    encodability, resolution, and fuel bound, replacing near-identical
    `lz77Greedy_spec_decode` and `lz77Lazy_spec_decode` proofs
  - Net reduction: ~60 lines of duplicate proof code eliminated
- **Kept public API stable**: `tokensToSymbols_encodable`, `lz77Greedy_spec_decode`,
  `tokensToSymbols_lazy_encodable`, `lz77Lazy_spec_decode` remain as thin wrappers
- **No theorem statements modified** — proof refactoring only

### HuffmanEncodeCorrect.lean (secondary focus)
- **Deduplicated `canonicalCodes_go_inv` invocation** in `canonicalCodes_correct_pos`:
  was called identically twice (once for code value, once for length), now called
  once with result used for both conjuncts. Saved ~20 lines.
- **Removed unused `hls_i` binding** from `canonicalCodes_hasLeaf`
- **Added comment** explaining UInt8→Nat bridge (`hlen_pos_nat`) needed for omega

### DeflateDynamic.lean (spot check)
- **Removed unused `i` parameter** from `writeCLEntries` — the parameter was
  incremented but never read (termination was on `entries.length`)
- **Deduplicated end-of-block writing** in `deflateDynamic` — both branches of
  the `if data.size == 0` wrote identical end-of-block + flush code

## Review findings (not acted on)

- **Table correspondence lemmas are all used**: `specLengthBase_step`,
  `specLengthBase_monotone`, `specDistBase_step`, `specDistBase_monotone` are all
  needed by `findLengthCode_agree` / `findDistCode_agree`. No dead code found.
- **File size**: DeflateFixedCorrect.lean is now ~725 lines (was 735). Still under
  the 1000-line threshold. A natural split boundary exists between the table
  bridge lemmas (lines 200-460) and the emitTokens correspondence (lines 500+),
  but splitting is not yet necessary.
- **`[i]!` bounds in DeflateDynamic.lean**: Several runtime bounds checks could
  potentially be replaced with proven-bounds access, but this is future work
  requiring spec-level proofs about `canonicalCodes` array sizes and frequency
  table sizes.
- **No linter warnings** in the three reviewed files (only expected sorry warnings).
- **No upstream-worthy lemmas** identified in this review — the helper lemmas are
  all project-specific.

## Verification

- `lake build` passes
- `lake exe test` passes (all tests)
- Sorry count: 8 (unchanged: 5 in DeflateFixedCorrect, 3 in DeflateEncodeDynamic)
- Net diff: -34 lines (83 insertions, 117 deletions)
